<!-- TOP ICON SECTION -->
<div class="map-journey-menu" fxLayout="row" fxLayoutAlign="space-around center">
  <!-- <mat-icon>chevron_left</mat-icon> -->
  <mat-icon (click)="LegendTopIconClicked('journeys')">query_builder</mat-icon>
  <mat-icon (click)="LegendTopIconClicked('albums')" class="disabled-icon">crop_original</mat-icon>
  <mat-icon (click)="LegendTopIconClicked('lists')" class="disabled-icon">format_list_numbered</mat-icon>
  <mat-icon (click)="LegendTopIconClicked('delete')">delete_outline</mat-icon>
  <!-- <mat-icon>chevron_right</mat-icon> -->
</div>

<!-- MAIN ACCORDION SECTION -->
<div [hidden]="!ShowUpIndicator" class="more-indicator more-above-indicator">
  <mat-icon>expand_less</mat-icon>
</div>
<mat-accordion #matAccordionChild 
  [ngStyle]="{'margin-top':ShowUpIndicator ? '60px' : '40px' }"
  [togglePosition]="'before'" 
  [multi]="true" cdkDropList 
  (cdkDropListDropped)="DropGroup($event)" >
  
  <!-- JOURNEY ACTIVITY GROUPS -->
  <mat-expansion-panel cdkDrag hideToggle *ngFor="let activityGroup of Journey?.ActivityGroups; index as idx"
    [expanded]="OpenPanels.includes(idx)"
    (opened)="PanelOpened(activityGroup, idx)"
    (closed)="PanelClosed(activityGroup, idx)" cdkDropList
    id="{{activityGroup.Title}}" [cdkDropListData]="activityGroup.Activities" [cdkDropListConnectedTo]="DropListArray"
    (cdkDropListDropped)="DropActivity($event)">
    <mat-expansion-panel-header>
      <mat-panel-title fxLayout="row" fxLayoutAlign="space-between center">
        <mat-icon class="group-expanded-indicator" *ngIf="!activityGroup.PanelOpenState">arrow_right</mat-icon>
        <mat-icon class="group-expanded-indicator" *ngIf="activityGroup.PanelOpenState">arrow_drop_down</mat-icon>
        <div>{{ activityGroup.Title | uppercase }}</div>
        <mat-checkbox [checked]="activityGroup.Checked" (change)="OnAGCheckChange($event, activityGroup)"
          (click)="$event.stopPropagation();">
        </mat-checkbox>
      </mat-panel-title>
    </mat-expansion-panel-header>

    <!-- GROUP DRAG PREVIEW -->
    <div *cdkDragPreview>
      <div class="group-drag-preview">
        <mat-expansion-panel-header>
          <mat-panel-title fxLayout="row" fxLayoutAlign="space-between center">
            <mat-icon class="group-expanded-indicator" *ngIf="!activityGroup.PanelOpenState">arrow_right</mat-icon>
            <mat-icon class="group-expanded-indicator" *ngIf="activityGroup.PanelOpenState">arrow_drop_down</mat-icon>
            <div>{{ activityGroup.Title | uppercase }}</div>
            <mat-checkbox [checked]="activityGroup.Checked" (change)="OnAGCheckChange($event, activityGroup)"
              (click)="$event.stopPropagation();">
            </mat-checkbox>
          </mat-panel-title>
        </mat-expansion-panel-header>
      </div>
    </div>
    <!-- END GROUP DRAG PREVIEW -->

    <!-- JOURNEY ACTIVITIES -->
    <div 
      cdkDrag 
      *ngFor="let activity of activityGroup.Activities" 
      fxLayout="row" 
      fxLayoutGap="10px"
      fxLayoutAlign="space-between center"
      class="activity-display" 
      (click)="onActivityClickToNavigate(activity)"
      [ngClass]="{'active-activity': ClickedActivityId && (ClickedActivityId  === activity.ID)}">
      
      <span>
        <mat-icon>{{ activity.WidgetIcon }}</mat-icon>
      </span>
      
      <span *ngIf="!activity.locationData" class="activity-display-title">{{ activity.Title }}</span>

      <div 
        *ngIf="activity.locationData" 
        class="activity-display-location"
        fxLayout="column">
        <span class="activity-location-title">{{ activity.locationData.Title }}</span>
        <span class="activity-location-address">
          <span>
            {{ activity.locationData.Town }}, 
            {{ activity.locationData.State }},
            {{ activity.locationData.Country }} 
          </span>
        </span>
      </div>

      <div>
        <span *ngIf="OpenPanels.includes(idx)" class="star" (click)="onFavoritedClick(activity); $event.stopPropagation()"
          [ngClass]="activity.Favorited ? 'star-favorited' : 'star-normal'"></span>
        <mat-checkbox [checked]="activity.Checked" (change)="OnActivityCheckChange($event, activity);"
          (click)="$event.stopPropagation();"></mat-checkbox>
      </div>


      <!-- ACTIVITY DRAG PREVIEW BEGIN -->
      <div *cdkDragPreview>
        <div class="activity-display-drag-preview" fxLayout="row" fxLayoutAlign="space-between center">
          <span>
            <mat-icon>{{ activity.WidgetIcon }}</mat-icon>
          </span>
          <span class="activity-display-title">{{ activity.Title }}</span>
          <div  class="activity-display-location">
            <span class="activity-location-title">{{ activity.locationData.Title }}</span>
            <br />
            <span class="activity-location-address">
              <span>{{ activity.locationData.Town }}, {{ activity.locationData.State }},
                {{ activity.locationData.Country }}</span>
            </span>
          </div>
          <div>
            <span class="star" (click)="onFavoritedClick(activity); $event.stopPropagation()"
              [ngClass]="activity.Favorited ? 'star-favorited' : 'star-normal'"></span>
            <mat-checkbox [checked]="activity.Checked" (change)="OnActivityCheckChange($event, activity);"
              (click)="$event.stopPropagation();"></mat-checkbox>
          </div>
        </div>
      </div>
      <!-- ACTIVITY DRAG PREVIEW END -->



    </div>

  </mat-expansion-panel>

</mat-accordion>